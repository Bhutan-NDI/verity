.deploy-common:
  stage: deploy
  script:
    - ls verity/target/verity-application*.deb
    - export debianPackage=`ls verity/target/verity-application*.deb`
    - >
      if [ ! -z "${debianPackage}" ]; then
        export VERITY_VERSION=`echo "$debianPackage" | cut -d'_' -f2`
      else
        /bin/false
      fi
    - curl
      --insecure
      --request POST
      --form token=$TRIGGER_API_TOKEN
      --form ref=$TRIGGERAPI_REF_VERITY_RELEASE
      --form "variables[VERITY_PACKAGE_VERSION]=$VERITY_VERSION"
      --form "variables[TARGET_ENV]=$TARGET_ENVIRONMENT"
      --form "variables[CI_PROJECT_ID_SOURCE]=$CI_PROJECT_ID"
      --form "variables[UPSTREAM_BRANCH]=$CI_COMMIT_REF_NAME"
      --form "variables[MERGE_FORK_PROJECT_ID]=$MERGE_FORK_PROJECT_ID"
      --form "variables[MERGE_FORK_BRANCH]=$MERGE_FORK_BRANCH"
      $TRIGGERAPI_URL_VERITY_RELEASE
  tags:
    - docker-machine
  needs: ["package" ,"publish-deb", "publish-docker"]

.deploy-k8s:
  stage: deploy
  script:
    - ls verity/target/verity-application*.deb
    - export debianPackage=`ls verity/target/verity-application*.deb`
    - >
      if [ ! -z "${debianPackage}" ]; then
        export VERITY_VERSION=`echo "$debianPackage" | cut -d'_' -f2`
      else
        /bin/false
      fi
    - curl
      --request POST
      --form token=$TRIGGER_API_K8S_TOKEN
      --form ref=master
      --form "variables[VERITY_PACKAGE_VERSION]=$VERITY_VERSION"
      $TRIGGERAPI_URL_VERITY_K8S_RELEASE
  tags:
    - docker-machine
  needs: ["package" ,"publish-deb", "publish-docker"]
  only:
    refs:
      - main@evernym/verity/verity

deploy-manually-team1:
  extends: .deploy-common
  variables:
    TARGET_ENVIRONMENT: 'team1'
    TRIGGERAPI_REF_VERITY_RELEASE: $TARGET_ENVIRONMENT
    MERGE_FORK_PROJECT_ID: "766"
    MERGE_FORK_BRANCH: $TARGET_ENVIRONMENT
  when: manual
  only:
    refs:
      - main@evernym/verity/verity

.deploy-manually-team2:
  extends: .deploy-common
  variables:
    TARGET_ENVIRONMENT: 'team2'
  when: manual

deploy-dev-rc: # default branch for automatic deployment verity master to dev-rc
  extends:
    - .deploy-common
  variables:
    TARGET_ENVIRONMENT: 'dev-rc'
    TRIGGERAPI_REF_VERITY_RELEASE: $TARGET_ENVIRONMENT
    MERGE_FORK_PROJECT_ID: "766"
    MERGE_FORK_BRANCH: $TARGET_ENVIRONMENT
  only:
    refs:
      - main@evernym/verity/verity

deploy-manually-dev-rc: # special branch for manual deployment verity master with control-repo changes to dev-rc: MERGE_FORK_PROJECT_ID and MERGE_FORK_BRANCH must be provided in job UI
  extends:
    - .deploy-common
  variables:
    TARGET_ENVIRONMENT: 'dev-rc'
    TRIGGERAPI_REF_VERITY_RELEASE: $TARGET_ENVIRONMENT
    MERGE_FORK_PROJECT_ID: "766"
    MERGE_FORK_BRANCH: $TARGET_ENVIRONMENT
  when: manual
  only:
    refs:
      - main@evernym/verity/verity
